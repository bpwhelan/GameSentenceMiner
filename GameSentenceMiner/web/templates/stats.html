<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GSM Dashboard</title>
    <!-- Include Chart.js from a CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Include html2canvas for screenshot functionality -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    
    <!-- Include shared theme styles -->
    {% include 'components/theme-styles.html' %}
    
    <!-- Include shared CSS -->
    <link rel="stylesheet" href="/static/css/shared.css">
    
    <!-- Include stats-specific CSS -->
    <link rel="stylesheet" href="/static/css/stats.css">
    
    <!-- Include shared kanji grid CSS -->
    <link rel="stylesheet" href="/static/css/kanji-grid.css">
</head>
<body>

<div class="container">
    <h1>GSM - Statistics</h1>
    
    <!-- Include shared navigation -->
    {% include 'components/navigation.html' %}

    <!-- Historical View Indicator -->
    <div id="historicalViewIndicator" class="historical-view-indicator" style="display: none;">
        üìÖ <strong>Historical View:</strong> Showing stats as of <span id="historicalViewDate"></span>
        <button id="exitHistoricalView" class="exit-historical-btn">Return to Current</button>
    </div>

    <!-- Dashboard Statistics Sections -->
    <div class="dashboard-container">
        <!-- Current Game Statistics Panel -->
        <div class="dashboard-card current-game" id="currentGameCard">
            <div class="dashboard-card-header">
                <div>
                    <h3 class="dashboard-card-title">
                        <span class="dashboard-card-icon">üéÆ</span>
                        Current Game Statistics
                    </h3>
                    <p class="dashboard-card-subtitle" id="currentGameName">Loading...</p>
                </div>
                <div class="dashboard-streak-indicator" id="currentGameStreak" style="display: none;">
                    <span id="currentStreakValue">0</span> day streak
                </div>
            </div>
            
            <div class="dashboard-stats-grid" id="currentGameStats">
                <div class="dashboard-stat-item tooltip" data-tooltip="Total characters read in this game">
                    <span class="dashboard-stat-value" id="currentTotalChars">-</span>
                    <span class="dashboard-stat-label">Characters</span>
                </div>
                <div class="dashboard-stat-item tooltip" data-tooltip="Total time spent reading this game">
                    <span class="dashboard-stat-value" id="currentTotalTime">-</span>
                    <span class="dashboard-stat-label">Time Spent</span>
                </div>
                <div class="dashboard-stat-item tooltip" data-tooltip="Average reading speed for this game">
                    <span class="dashboard-stat-value" id="currentReadingSpeed">-</span>
                    <span class="dashboard-stat-label">Chars/Hour</span>
                </div>
                <div class="dashboard-stat-item tooltip" data-tooltip="Number of reading sessions for this game">
                    <span class="dashboard-stat-value" id="currentSessions">-</span>
                    <span class="dashboard-stat-label">Sessions</span>
                </div>
            </div>
            
            <div class="dashboard-progress-section">
                <div class="dashboard-progress-title">Recent Progress</div>
                <div class="dashboard-progress-items">
                    <div class="dashboard-progress-item">
                        <div class="dashboard-progress-value positive" id="currentMonthlyChars">-</div>
                        <div class="dashboard-progress-label">Monthly Characters</div>
                    </div>
                    <div class="dashboard-progress-item">
                        <div class="dashboard-progress-value neutral" id="currentFirstDate">-</div>
                        <div class="dashboard-progress-label">Started</div>
                    </div>
                    <div class="dashboard-progress-item">
                        <div class="dashboard-progress-value neutral" id="currentLastDate">-</div>
                        <div class="dashboard-progress-label">Last Activity</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Games Historical Overview -->
        <div class="dashboard-card all-games" id="allGamesCard">
            <div class="dashboard-card-header">
                <div>
                    <h3 class="dashboard-card-title">
                        <span class="dashboard-card-icon">üìö</span>
                        All Games Overview
                    </h3>
                    <p class="dashboard-card-subtitle" id="totalGamesCount">Loading...</p>
                </div>
                <div class="dashboard-streak-indicator" id="allGamesStreak" style="display: none;">
                    <span id="allStreakValue">0</span> day streak
                </div>
            </div>
            
            <div class="dashboard-stats-grid" id="allGamesStats">
                <div class="dashboard-stat-item tooltip" data-tooltip="Total characters read across all games">
                    <span class="dashboard-stat-value" id="allTotalChars">-</span>
                    <span class="dashboard-stat-label">Characters</span>
                </div>
                <div class="dashboard-stat-item tooltip" data-tooltip="Total time spent reading across all games">
                    <span class="dashboard-stat-value" id="allTotalTime">-</span>
                    <span class="dashboard-stat-label">Time Spent</span>
                </div>
                <div class="dashboard-stat-item tooltip" data-tooltip="Overall average reading speed">
                    <span class="dashboard-stat-value" id="allReadingSpeed">-</span>
                    <span class="dashboard-stat-label">Chars/Hour</span>
                </div>
                <div class="dashboard-stat-item tooltip" data-tooltip="Total number of reading sessions">
                    <span class="dashboard-stat-value" id="allSessions">-</span>
                    <span class="dashboard-stat-label">Sessions</span>
                </div>
            </div>
            
            <div class="dashboard-progress-section">
                <div class="dashboard-progress-title">Overall Progress</div>
                <div class="dashboard-progress-items">
                    <div class="dashboard-progress-item">
                        <div class="dashboard-progress-value positive" id="allMonthlyChars">-</div>
                        <div class="dashboard-progress-label">Monthly Characters</div>
                    </div>
                    <div class="dashboard-progress-item">
                        <div class="dashboard-progress-value neutral" id="allUniqueGames">-</div>
                        <div class="dashboard-progress-label">Games Played</div>
                    </div>
                    <div class="dashboard-progress-item">
                        <div class="dashboard-progress-value neutral" id="allTotalSentences">-</div>
                        <div class="dashboard-progress-label">Total Sentences</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading/Error states for dashboard -->
    <div class="dashboard-loading" id="dashboardLoading" style="display: none;">
        <div class="spinner"></div>
        <span>Loading dashboard statistics...</span>
    </div>

    <div class="dashboard-error" id="dashboardError" style="display: none;">
        <div class="dashboard-error-icon">‚ö†Ô∏è</div>
        <div class="dashboard-error-message">Failed to load dashboard statistics</div>
        <button class="dashboard-retry-btn" data-action="loadDashboardData">Retry</button>
    </div>


    <!-- Today's Overview Card -->
    <div class="dashboard-card today-overview" id="todayOverviewCard" style="margin-bottom: 24px;">
        <div class="dashboard-card-header">
            <h3 class="dashboard-card-title">
                <span class="dashboard-card-icon">üìÖ</span>
                Today's Overview
            </h3>
            <p class="dashboard-card-subtitle" id="todayDate">Loading...</p>
        </div>
        <div class="dashboard-stats-grid" id="todayStats">
            <div class="dashboard-stat-item tooltip" data-tooltip="Total hours spent reading today">
                <span class="dashboard-stat-value" id="todayTotalHours">-</span>
                <span class="dashboard-stat-label">Hours Spent</span>
            </div>
            <div class="dashboard-stat-item tooltip" data-tooltip="Total characters read today">
                <span class="dashboard-stat-value" id="todayTotalChars">-</span>
                <span class="dashboard-stat-label">Characters</span>
            </div>
            <div class="dashboard-stat-item tooltip" data-tooltip="Number of reading sessions today">
                <span class="dashboard-stat-value" id="todaySessions">-</span>
                <span class="dashboard-stat-label">Sessions</span>
            </div>
            <div class="dashboard-stat-item tooltip" data-tooltip="Average reading speed today">
                <span class="dashboard-stat-value" id="todayCharsPerHour">-</span>
                <span class="dashboard-stat-label">Chars/Hour</span>
            </div>
        </div>
    </div>

        <!-- Goal Progress Chart -->
    <div class="dashboard-card goal-progress-chart" id="goalProgressChart" style="margin-bottom: 30px;">
        <div class="dashboard-card-header">
            <h3 class="dashboard-card-title">
                <span class="dashboard-card-icon">üéØ</span>
                Goal Progress Chart
            </h3>
            <p class="dashboard-card-subtitle">Track your reading goals and projected completion dates</p>
        </div>
        
        <div class="goal-progress-grid">
            <!-- Reading Hours Goal -->
            <div class="goal-progress-item">
                <div class="goal-progress-header">
                    <div class="goal-progress-label">
                        <span class="goal-icon">‚è±Ô∏è</span>
                        Reading Hours
                    </div>
                    <div class="goal-progress-values">
                        <span class="goal-current" id="goalHoursCurrent">-</span>
                        <span class="goal-separator">/</span>
                        <span class="goal-target" id="goalHoursTarget">-</span>
                    </div>
                </div>
                <div class="goal-progress-bar">
                    <div class="goal-progress-fill" id="goalHoursProgress" data-percentage="0"></div>
                </div>
                <div class="goal-progress-info">
                    <span class="goal-percentage" id="goalHoursPercentage">0%</span>
                    <span class="goal-projection" id="goalHoursProjection">-</span>
                </div>
            </div>

            <!-- Character Count Goal -->
            <div class="goal-progress-item">
                <div class="goal-progress-header">
                    <div class="goal-progress-label">
                        <span class="goal-icon">üìñ</span>
                        Characters Read
                    </div>
                    <div class="goal-progress-values">
                        <span class="goal-current" id="goalCharsCurrent">-</span>
                        <span class="goal-separator">/</span>
                        <span class="goal-target" id="goalCharsTarget">-</span>
                    </div>
                </div>
                <div class="goal-progress-bar">
                    <div class="goal-progress-fill" id="goalCharsProgress" data-percentage="0"></div>
                </div>
                <div class="goal-progress-info">
                    <span class="goal-percentage" id="goalCharsPercentage">0%</span>
                    <span class="goal-projection" id="goalCharsProjection">-</span>
                </div>
            </div>

            <!-- Games Goal -->
            <div class="goal-progress-item">
                <div class="goal-progress-header">
                    <div class="goal-progress-label">
                        <span class="goal-icon">üéÆ</span>
                        Games
                    </div>
                    <div class="goal-progress-values">
                        <span class="goal-current" id="goalGamesCurrent">-</span>
                        <span class="goal-separator">/</span>
                        <span class="goal-target" id="goalGamesTarget">-</span>
                    </div>
                </div>
                <div class="goal-progress-bar">
                    <div class="goal-progress-fill" id="goalGamesProgress" data-percentage="0"></div>
                </div>
                <div class="goal-progress-info">
                    <span class="goal-percentage" id="goalGamesPercentage">0%</span>
                    <span class="goal-projection" id="goalGamesProjection">-</span>
                </div>
            </div>
        </div>

        <!-- Loading/Error states -->
        <div class="goal-progress-loading" id="goalProgressLoading" style="display: none;">
            <div class="spinner"></div>
            <span>Loading goal progress...</span>
        </div>

        <div class="goal-progress-error" id="goalProgressError" style="display: none;">
            <div class="goal-progress-error-icon">‚ö†Ô∏è</div>
            <div class="goal-progress-error-message">Failed to load goal progress</div>
            <button class="retry-btn" onclick="loadGoalProgress()">Retry</button>
        </div>
    </div>

    <div class="chart-container">
        <h2>Activity Heatmap</h2>
        <div id="heatmapContainer"></div>
    </div>

    <div class="chart-container">
        <h2>Lines Received Over Time</h2>
        <canvas id="linesChart"></canvas>
    </div>

    <div class="chart-container">
        <h2>Characters Read Over Time</h2>
        <canvas id="charsChart"></canvas>
    </div>

    <div class="chart-container">
        <h2>Reading Chars Quantity</h2>
        <canvas id="readingCharsChart"></canvas>
    </div>

    <div class="chart-container">
        <h2>Reading Time Quantity</h2>
        <canvas id="readingTimeChart"></canvas>
    </div>

    <div class="chart-container">
        <h2>Reading Speed Improvement</h2>
        <canvas id="readingSpeedPerGameChart"></canvas>
    </div>

    <div class="chart-container">
        <h2>Kanji Grid</h2>
        <div id="kanjiGridContainer">
            <div id="kanjiCounter" class="kanji-counter">
                Unique Kanji Seen: <span id="kanjiCount">0</span>
            </div>
            <div id="kanjiGrid" class="kanji-grid"></div>
            <div class="kanji-legend">
                <span>Rarely Seen</span>
                <div class="kanji-legend-item" style="background-color: #ebedf0;" title="No encounters"></div>
                <div class="kanji-legend-item" style="background-color: #e6342e;" title="Seen once"></div>
                <div class="kanji-legend-item" style="background-color: #e6dc2e;" title="Occasionally seen"></div>
                <div class="kanji-legend-item" style="background-color: #3be62f;" title="Frequently seen"></div>
                <div class="kanji-legend-item" style="background-color: #2ee6e0;" title="Most frequently seen"></div>
                <span>Frequently Seen</span>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Statistics Settings</h3>
                <span class="close-btn" id="closeSettingsModal">&times;</span>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Configure how reading time and sessions are calculated for your statistics.
                </p>
                
                <form id="settingsForm">
                    <div style="margin-bottom: 20px;">
                        <label for="afkTimer" style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                            AFK Timer (seconds)
                        </label>
                        <input
                            type="number"
                            id="afkTimer"
                            name="afk_timer_seconds"
                            style="width: 90%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 14px;"
                            placeholder="120"
                        >
                        <small style="color: var(--text-tertiary); font-size: 12px; margin-top: 4px; display: block;">
                            Maximum time between activities that still counts as active reading
                        </small>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="sessionGap" style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                            Session Gap (seconds)
                        </label>
                        <input
                            type="number"
                            id="sessionGap"
                            name="session_gap_seconds"
                            style="width: 90%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 14px;"
                            placeholder="3600"
                        >
                        <small style="color: var(--text-tertiary); font-size: 12px; margin-top: 4px; display: block;">
                            Time gap that triggers a new reading session
                        </small>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label for="heatmapYear" style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                            Heatmap Display Year
                        </label>
                        <select
                            id="heatmapYear"
                            name="heatmap_year"
                            style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 14px;"
                        >
                            <option value="all">All Years</option>
                        </select>
                        <small style="color: var(--text-tertiary); font-size: 12px; margin-top: 4px; display: block;">
                            Select which year to display in the reading activity heatmap
                        </small>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label for="historicalDate" style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                            View Stats As Of Date
                        </label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input
                                type="date"
                                id="historicalDate"
                                name="historical_date"
                                style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 14px;"
                            >
                            <button
                                type="button"
                                id="resetHistoricalDate"
                                style="padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--bg-secondary); color: var(--text-primary); cursor: pointer; font-size: 14px;"
                                title="Reset to current date"
                            >
                                Reset
                            </button>
                        </div>
                        <small style="color: var(--text-tertiary); font-size: 12px; margin-top: 4px; display: block;">
                            View your stats as they were on this date (useful for tracking progress over time)
                        </small>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label for="streakRequirement" style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                            Streak Requirement (hours)
                        </label>
                        <input
                            type="number"
                            id="streakRequirement"
                            name="streak_requirement_hours"
                            min="0.01"
                            max="24"
                            step="0.01"
                            style="width: 90%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 14px;"
                            placeholder="1.0"
                        >
                        <small style="color: var(--text-tertiary); font-size: 12px; margin-top: 4px; display: block;">
                            Minimum hours of reading activity required to maintain streak (0.01-24 hours)
                        </small>
                    </div>

                    <!-- Reading Goals Section -->
                    <div style="margin-bottom: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                            Reading Goals Configuration
                        </label>
                        <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
                            Set your long-term reading targets for tracking progress and projections.
                        </p>
                        
                        <div style="margin-bottom: 15px;">
                            <label for="readingHoursTarget" style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                                Reading Hours Target
                            </label>
                            <input
                                type="number"
                                id="readingHoursTarget"
                                name="reading_hours_target"
                                min="1"
                                max="10000"
                                style="width: 90%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 14px;"
                                placeholder="1500"
                            >
                            <small style="color: var(--text-tertiary); font-size: 12px; margin-top: 4px; display: block;">
                                Total reading hours goal (1-10,000 hours) - Default: 1500 hours based on TMW N1 achievement
                            </small>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label for="characterCountTarget" style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                                Character Count Target
                            </label>
                            <input
                                type="number"
                                id="characterCountTarget"
                                name="character_count_target"
                                min="1000"
                                max="1000000000"
                                style="width: 90%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 14px;"
                                placeholder="25000000"
                            >
                            <small style="color: var(--text-tertiary); font-size: 12px; margin-top: 4px; display: block;">
                                Total characters read goal (1,000-1,000,000,000) - Default: 25 million characters
                            </small>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label for="gamesTarget" style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                                Games/Visual Novels Target
                            </label>
                            <input
                                type="number"
                                id="gamesTarget"
                                name="games_target"
                                min="1"
                                max="1000"
                                style="width: 90%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 14px;"
                                placeholder="100"
                            >
                            <small style="color: var(--text-tertiary); font-size: 12px; margin-top: 4px; display: block;">
                                Number of games/visual novels to complete (1-1,000) - Default: 100 based on Refold standards
                            </small>
                        </div>
                    </div>

                    <!-- Import ExStatic Lines Section -->
                    <div style="margin-bottom: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                            Import ExStatic Lines
                        </label>
                        <div style="margin-bottom: 10px;">
                            <input
                                type="file"
                                id="exstaticFile"
                                accept=".csv"
                                style="width: 90%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 14px;"
                            >
                            <small style="color: var(--text-tertiary); font-size: 12px; margin-top: 4px; display: block;">
                                Select an ExStatic CSV file to import reading data into GSM
                            </small>
                        </div>
                        <button
                            type="button"
                            id="importExstaticBtn"
                            style="width: 90%; padding: 10px; background: #666; color: white; border: none; border-radius: 5px; font-size: 14px; cursor: not-allowed; margin-bottom: 10px;"
                            disabled
                        >
                            Import ExStatic Lines
                        </button>
                        <div id="importProgress" style="display: none; margin-bottom: 10px;">
                            <div style="background: var(--bg-tertiary); border-radius: 5px; overflow: hidden; height: 20px; position: relative;">
                                <div id="importProgressBar" style="background: var(--primary-color); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                                <span id="importProgressText" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; color: var(--text-primary);">0%</span>
                            </div>
                        </div>
                        <div id="importStatus" style="display: none; padding: 10px; border-radius: 5px; font-size: 14px;"></div>
                    </div>
                </form>
                
                <div id="settingsError" style="display: none; background: var(--danger-color); color: white; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 14px;"></div>
                <div id="settingsSuccess" style="display: none; background: var(--success-color); color: white; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 14px;"></div>
            </div>
            <div class="modal-footer">
                <button id="cancelSettingsBtn" class="cancel-btn">Cancel</button>
                <button id="saveSettingsBtn" class="confirm-delete-btn">Save Settings</button>
            </div>
        </div>
    </div>
</div>


<!-- Include shared JavaScript first (required dependency for stats.js) -->
<script src="/static/js/shared.js"></script>
<script src="/static/js/kanji-grid.js"></script>
<script src="/static/js/stats.js"></script>

<style>
.historical-view-indicator {
    background: linear-gradient(90deg, #ffeaa7, #fdcb6e);
    border: 1px solid #e17055;
    color: #2d3436;
    padding: 12px 20px;
    border-radius: 8px;
    margin: 15px 0;
    font-size: 14px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: space-between;
    animation: slideIn 0.3s ease-out;
}

.exit-historical-btn {
    background: #e17055;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: background 0.2s;
}

.exit-historical-btn:hover {
    background: #d63031;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Dark theme support */
[data-theme="dark"] .historical-view-indicator {
    background: linear-gradient(90deg, #f39c12, #e67e22);
    border-color: #d35400;
    color: #2c3e50;
}
</style>

</body>
</html>