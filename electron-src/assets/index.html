<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <!-- TODO: IMPORT THESE PROPERLY -->
    <link rel="stylesheet" href="xterm.css" />
    <script src="xterm.js"></script>
    <script src="xterm-addon-fit.js"></script>

    <style>
        html, body {
            overflow: hidden;
            height: 100%;
            scrollbar-width: none; /* Firefox */
        }
        html::-webkit-scrollbar, body::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Edge */
        }

        body.index {
            margin: 0;
            padding: 0;
            height: 100vh;
            background: #1a1a1a;
            color: #ffffff;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
        }

        .tab-bar {
            background: #2a2a2a;
            padding: 10px;
            display: flex;
            gap: 5px;
            height: 50px;
            flex-shrink: 0;
            box-sizing: border-box;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .tab-button {
            background: #3a3a3a;
            border: none;
            color: #ffffff;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .tab-button:hover {
            background: #4a4a4a;
        }

        .tab-button.active {
            background: #5a5a5a;
        }

        .tab-content {
            display: none;
            height: calc(100vh - 50px);
            flex: 1;
            overflow-y: auto;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        .tab-content::-webkit-scrollbar {
            display: none;  /* Chrome, Safari, Edge */
        }

        .tab-content.active {
            display: block;
            height: 100%;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        #stats {
            position: relative;
        }

        .stats-loading {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: #1a1a1a;
            color: #cfcfcf;
            font-size: 14px;
            letter-spacing: 0.2px;
        }

        .stats-loading .spinner {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 3px solid #3a3a3a;
            border-top-color: #8a8a8a;
            animation: stats-spin 1s linear infinite;
        }

        @keyframes stats-spin {
            to { transform: rotate(360deg); }
        }

        #terminal {
            width: 100%;
            height: 100%;
        }

        /* Python tab specific grid layout - max 2 columns */
        #python-grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            max-width: 100%;
            gap: 15px;
        }

        /* Ensure Python grid never exceeds 2 columns */
        @media (min-width: 900px) {
            #python-grid-container {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
    <title></title>
</head>

<body class="index">
    <!-- Include shared module with ipcRenderer, clipboard, and sharedState -->
    <script src="shared.js"></script>
    
    <div id="main-tab-bar" class="tab-bar">
        <!-- <span style="z-index:11;"> -->
            <button class="tab-button active" data-tab="obs">Home</button>
            <button class="tab-button" data-tab="ocr">OCR</button>
            <button class="tab-button" data-tab="stats">Stats</button>
            <button class="tab-button" data-tab="launcher">Game Settings</button>
            <!--        <button class="tab-button" data-tab="steam">Steam</button>-->
            <!--        <button class="tab-button" data-tab="vn">VN</button>-->
            <!--        <button class="tab-button" data-tab="yuzu" id="yuzu-button" style="display: none;">Yuzu</button>-->
            <button class="tab-button" data-tab="settings">Settings</button>
            <button class="tab-button" data-tab="python">Python</button>
            <button class="tab-button" data-tab="console">Console</button>
        <!-- </span> -->
        <span style="position: absolute; right: 0; top: 10; display: flex; align-items: center; gap: 12px; padding-right: 18px; z-index: 10;">
            <a id="github-link" href="#" title="GitHub" style="display: flex; align-items: center;">
                <svg height="32" width="32" viewBox="0 0 24 24" fill="#888" style="display: block;"><path d="M12 2C6.477 2 2 6.484 2 12.021c0 4.428 2.865 8.184 6.839 9.504.5.092.682-.217.682-.483 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.342-3.369-1.342-.454-1.157-1.11-1.465-1.11-1.465-.908-.62.069-.608.069-.608 1.004.07 1.532 1.032 1.532 1.032.892 1.53 2.341 1.088 2.91.832.091-.647.35-1.088.636-1.339-2.221-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.025A9.564 9.564 0 0 1 12 6.844c.85.004 1.705.115 2.504.337 1.909-1.295 2.748-1.025 2.748-1.025.546 1.378.202 2.397.1 2.65.64.7 1.028 1.595 1.028 2.688 0 3.847-2.337 4.695-4.566 4.944.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.749 0 .268.18.579.688.481C19.138 20.2 22 16.448 22 12.021 22 6.484 17.523 2 12 2z"/></svg>
            </a>
            <a id="discord-link" href="#" title="Discord" style="display: flex; align-items: center;">
                <svg height="32" width="32" viewBox="0 0 24 24" fill="#888" style="display: block;"><path d="M20.317 4.369A19.791 19.791 0 0 0 16.885 3.2a.074.074 0 0 0-.079.037c-.34.607-.719 1.396-.984 2.013a18.524 18.524 0 0 0-5.614 0 12.51 12.51 0 0 0-.997-2.013.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.684 4.369a.069.069 0 0 0-.032.027C.533 9.09-.32 13.579.099 18.021a.082.082 0 0 0 .031.056c2.128 1.566 4.195 2.518 6.29 3.155a.077.077 0 0 0 .084-.027c.484-.662.917-1.362 1.291-2.104a.076.076 0 0 0-.041-.104c-.693-.263-1.353-.577-1.984-.942a.077.077 0 0 1-.008-.127c.133-.1.266-.203.392-.308a.074.074 0 0 1 .077-.01c4.172 1.905 8.683 1.905 12.813 0a.073.073 0 0 1 .078.009c.127.105.26.208.393.308a.077.077 0 0 1-.006.127 12.298 12.298 0 0 1-1.985.942.076.076 0 0 0-.04.105c.375.74.808 1.44 1.29 2.104a.076.076 0 0 0 .084.028c2.096-.637 4.163-1.589 6.291-3.155a.077.077 0 0 0 .03-.055c.5-5.177-.838-9.637-3.548-13.625a.061.061 0 0 0-.03-.028zM8.02 15.331c-1.183 0-2.156-1.085-2.156-2.419 0-1.333.955-2.418 2.156-2.418 1.21 0 2.175 1.095 2.156 2.418 0 1.334-.955 2.419-2.156 2.419zm7.974 0c-1.183 0-2.156-1.085-2.156-2.419 0-1.333.955-2.418 2.156-2.418 1.21 0 2.175 1.095 2.156 2.418 0 1.334-.946 2.419-2.156 2.419z"/></svg>
            </a>
                <script>
                    // Open links in user's default browser via Electron shell
                    document.getElementById('github-link').addEventListener('click', function(e) {
                        e.preventDefault();
                        window.ipcRenderer.invoke('open-external', 'https://github.com/bpwhelan/GameSentenceMiner');
                    });
                    document.getElementById('discord-link').addEventListener('click', function(e) {
                        e.preventDefault();
                        window.ipcRenderer.invoke('open-external', 'https://discord.gg/yP8Qse6bb8');
                    });
                </script>
        </span>
    </div>
    <div id="launcher" class="tab-content">
        <iframe src="launcher.html"></iframe>
    </div>
    <div id="obs" class="tab-content active">
        <iframe src="home.html"></iframe>
    </div>
    <div id="steam" class="tab-content">
        <iframe src="steam.html"></iframe>
    </div>
    <div id="vn" class="tab-content">
        <iframe src="VN.html"></iframe>
    </div>
    <div id="yuzu" class="tab-content">
        <iframe src="yuzu.html"></iframe>
    </div>
    <div id="settings" class="tab-content">
        <iframe src="settings.html"></iframe>
    </div>
    <div id="stats" class="tab-content">
        <div id="stats-loading" class="stats-loading">
            <div class="spinner"></div>
            <div>Waiting for GSM stats to load...</div>
        </div>
        <iframe src=""></iframe>
    </div>
    <div id="python" class="tab-content">
        <div id="python-tab-container" class="tab-container">
            <h2>Python Management</h2>
            <h3>‚ö†ÔøΩEÔøΩEEverything on this tab has the potential to break GSM. Proceed with Caution. ‚ö†ÔøΩEÔøΩE/h3>
            <div id="python-grid-container" class="grid-container">
                <!-- CUDA Installation Card -->
                <div class="card">
                    <h2 class="collapsible-header">CUDA Installation</h2>
                    <div class="collapsible-content" style="display: block;">
                        <div class="form-group">
                            <div class="input-group">
                                <button id="install-cuda-btn" class="danger">Install CUDA GPU Support</button>
                                <div class="tooltip">‚ùÅE
                                    <span class="tooltiptext">Install onnxruntime-gpu with CUDA support for GPU acceleration.
                                        This enables much faster Whisper Processing and OCR performance.</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <button id="uninstall-cuda-btn" class="danger">Uninstall CUDA Support</button>
                                <div class="tooltip">‚ùÅE
                                    <span class="tooltiptext">Uninstall onnxruntime-gpu (CUDA Support). Use this if you are experiencing issues with GPU acceleration.</span>
                                </div>
                            </div>
                            <!-- <div class="input-group">
                                <button id="cuda-guide-btn" class="secondary">üìñ CUDA Compatibility Guide</button>
                                <div class="tooltip">‚ùÅE
                                    <span class="tooltiptext">
                                        <strong>Choose your CUDA version:</strong><br>
                                        ‚Ä¢ <strong>CUDA 12.6:</strong> Most stable, works with older GPUs<br>
                                        ‚Ä¢ <strong>CUDA 12.8:</strong> Recommended for most users (RTX 30/40 series)<br>
                                        ‚Ä¢ <strong>CUDA 12.9:</strong> Latest version, best performance for newest
                                        GPUs<br><br>
                                        <strong>Note:</strong> Your GPU driver must support the CUDA version you choose.
                                    </span>
                                </div>
                            </div> -->
                        </div>
                    </div>
                </div>

                <!-- GSM Management Card -->
                <div class="card">
                    <h2 class="collapsible-header">GSM Management</h2>
                    <div class="collapsible-content" style="display: block;">
                        <div class="form-group">
                            <div class="input-group">
                                <button id="reset-deps-btn" class="secondary">Reset Python Dependencies</button>
                                <div class="tooltip">‚ùÅE
                                    <span class="tooltiptext">Syncs Python dependencies with the pinned lockfile (uv sync --locked). This restores the intended package versions.</span>
                                </div>
                            </div>
                            <!-- <div class="input-group">
                                <button id="repair-gsm-btn" class="danger">üîß Repair GSM</button>
                                <div class="tooltip">‚ùÅE
                                    <span class="tooltiptext">Complete reinstall of Python and GameSentenceMiner. This
                                        will remove all custom packages and restore to default state.</span>
                                </div>
                            </div> -->
                            <!-- <div class="input-group">
                                <button id="clean-cache-btn" class="secondary">üßπ Clean Python Cache</button>
                                <div class="tooltip">‚ùÅE
                                    <span class="tooltiptext">Clear pip cache and temporary files to fix installation
                                        issues</span>
                                </div>
                            </div> -->
                        </div>
                    </div>
                </div>

                <!-- Custom Package Installation Card -->
                <div class="card">
                    <h2 class="collapsible-header">Custom Package Installation</h2>
                    <div class="collapsible-content" style="display: block;">
                        <div class="form-group">
                            <div class="input-group">
                                <label for="custom-package-input" class="tooltip-indicator">Package Name:
                                    <span class="tooltiptext">Enter the name of the package you want to install (e.g.,
                                        numpy, requests, etc.) This may break things, and should only be used upon
                                        instruction.</span>
                                </label>
                                <input type="text" id="custom-package-input"
                                    placeholder="e.g., numpy, requests, etc." />
                                <button id="install-custom-package-btn" class="danger">Install Package</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Python Environment Info Card -->
                <div class="card">
                    <h2 class="collapsible-header">Python Environment Info</h2>
                    <div class="collapsible-content" style="display: block;">
                        <div class="form-group">
                            <div id="python-info-container">
                                <p id="python-version">Python Version: Loading...</p>
                                <p id="python-path">Python Path: Loading...</p>
                                <p id="pip-version">Pip Version: Loading...</p>
                            </div>
                            <div class="input-group">
                                <button id="refresh-python-info-btn" class="secondary">üîÑ Refresh Info</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Display -->
            <div class="card" id="python-status-card" style="display: none;">
                <div class="terminal-container" id="python-status">
                    <p id="python-status-text">Ready</p>
                </div>
            </div>
        </div>
    </div>
    <div id="ocr" class="tab-content">
        <!-- OCR content will be loaded dynamically from ocr-tab.html -->
        <div id="ocr-loading" style="display: flex; justify-content: center; align-items: center; height: 100%; color: #ffffff;">
            Loading OCR tab...
        </div>
    </div>
    <script>
        // Load OCR tab dynamically
        let ocrTabLoaded = false;
        
        async function loadOCRTab() {
            if (ocrTabLoaded) return;
            
            try {
                const response = await fetch('ocr-tab.html');
                const html = await response.text();
                document.getElementById('ocr').innerHTML = html;
                
                // Load the OCR JavaScript module
                const script = document.createElement('script');
                script.src = 'ocr-tab.js';
                script.onload = () => {
                    // Initialize the OCR tab after script loads
                    if (typeof window.initOCRTab === 'function') {
                        window.initOCRTab();
                    }
                };
                document.body.appendChild(script);
                
                ocrTabLoaded = true;
            } catch (error) {
                console.error('Failed to load OCR tab:', error);
                document.getElementById('ocr').innerHTML = '<div style="color: red; padding: 20px;">Failed to load OCR tab. Please refresh.</div>';
            }
        }
        
        // Preload OCR tab when the page loads (optional - you can also load on-demand)
        document.addEventListener('DOMContentLoaded', () => {
            // Load immediately or wait for first tab click
            // Uncomment the line below to preload:
            // loadOCRTab();
            
            // Or load on first OCR tab click:
            const ocrTabButton = document.querySelector('[data-tab="ocr"]');
            if (ocrTabButton) {
                ocrTabButton.addEventListener('click', loadOCRTab, { once: true });
            }
        });
    </script>
    <div id="console" class="tab-content">
        <div id="terminal"></div>
        <script>
            const term = new Terminal({
                fontFamily: '"Noto Sans Mono", "IPA Gothic", "Courier New", monospace', // Japanese-supporting fonts
                fontSize: 14,
                cursorBlink: false,
                allowProposedApi: true,
                theme: {
                    foreground: "#EEEEEE",
                    background: "#1a1a1a",
                    cursor: "#CFF5DB"
                },
            });
            const fitAddon = new FitAddon.FitAddon();
            let downloadStarted = false;
            let transcribeStarted = false;
            let vadStarted = false;
            let adjustmentStarted = false;
            
            term.loadAddon(fitAddon);
            term.open(document.getElementById('terminal'));
            fitAddon.fit();

            // Helper function to switch to console tab
            function switchToConsoleTab() {
                // Remove active from all tabs
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                // Activate console tab
                document.querySelector('[data-tab="console"]').classList.add('active');
                document.getElementById('console').classList.add('active');

                // Fit terminal
                setTimeout(() => {
                    fitAddon.fit();
                }, 100);
            }

            // Print and replace the same line when downloading
            function printDownloadStatus(data) {
                data = data.trimEnd(); // Remove trailing \n or \r\n
                if (!downloadStarted) {
                    downloadStarted = true;
                    term.write('\r\n'); // Move to new line for download start
                }
                term.write(`\x1b[32m${data}\x1b[0m\r`); // Green text for download status, carriage return to overwrite line
            }

            function printVADStatusBar(data) {
                if (data.startsWith("Transcription:")) {
                    if (!transcribeStarted) {
                        term.write('\r\n'); // Move to new line for VAD status start
                    }
                    transcribeStarted = true;
                    vadStarted = false;
                    adjustmentStarted = false;
                } else if (data.startsWith("VAD:")) {
                    if (!vadStarted) {
                        term.write('\r\n'); // Move to new line for VAD status start
                    }
                    vadStarted = true;
                    transcribeStarted = false;
                    adjustmentStarted = false;
                } else if (data.startsWith("Adjustment:")) {
                    if (!adjustmentStarted) {
                        term.write('\r\n'); // Move to new line for VAD status start
                    }
                    adjustmentStarted = true;
                    transcribeStarted = false;
                    vadStarted = false;
                }
                data = data.trimEnd(); // Remove trailing \n or \r\n
                term.write(`\x1b[32m${data}\x1b[0m\r`); // Green text for VAD status, carriage return to overwrite line
            }

            window.addEventListener('resize', () => fitAddon.fit());

            invalid_starts = ["Detected Language:"]

            ipcRenderer.on('terminal-output', (event, data) => {
                if (data.includes("Python not found")) {
                    switchToConsoleTab();
                }
                if (data.includes("ERROR: INFO:") || data.includes("DEBUG:") || data.includes("[OCR") || invalid_starts.some(start => data.startsWith(start))) {
                    return; // THIS IS DEBUG THAT SOMEHOW GETS THROUGH TO STDOUT
                }
                if (data.includes("Download:") || data.includes("Downloading:") || data.includes("Downloaded:")) {
                    printDownloadStatus(data);
                    return;
                }

                if (data.startsWith("UPDATED ANKI CARD")) {
                    term.write(`\x1b[32m${data}\x1b[0m\r\n`); // Green text for Anki updates
                    return;
                }

                if (data.startsWith("Transcription:") || data.startsWith("Transcribe:") || data.startsWith("VAD:") || data.startsWith("Adjustment:")) {
                    printVADStatusBar(data);
                    return;
                }

                transcribeStarted = false;
                vadStarted = false;
                adjustmentStarted = false;

                if (data.includes("GSM Loaded")) {
                    term.write(`\x1b[32m${data}\x1b[0m`); // Green text for initialization complete
                    return;
                }
                // if (data.includes("GameSentenceMiner - "))
                //     data = data.split("GameSentenceMiner - ")[1];
                if (data.includes("- ERROR -")) {
                    term.write(`\x1b[91m${data}\x1b[0m`); // Light red text for errors, no background
                } else if (data.includes("- WARNING -")) {
                    term.write(`\x1b[33mWARNING: ${data}\x1b[0m`); // Yellow text for warnings
                } else {
                    term.write(data);
                }
            });

            ipcRenderer.on('terminal-error', (event, data) => {
                const data_lower = data.toLowerCase();
                if (data.includes("INFO:") || data.includes("DEBUG:") || data.includes("ERROR:") || data.includes("[OCR")) {
                    return; // BAD STDERR, NOT SURE WHY THIS IS HAPPENING
                }
                if (data.includes("Install:stderr:")) {
                    term.write(`\x1b[32mGSM Install: ${data.split("Install:stderr:")[1].trim()}\x1b[0m\r\n`); // Green text for installation messages
                    return;
                }
                if (data_lower.includes('ocr:__init__')) {
                    term.write(`\x1b[32mOCR Initialization: ${data}\x1b[0m`); // Green text for OCR initialization
                    return;
                }
                if (data.includes("Transcription:") || data.includes("Transcribe:") || data.includes("VAD:") || data.includes("Adjustment:")) {
                    printVADStatusBar(data);
                    return;
                }

                transcribeStarted = false;
                vadStarted = false;
                adjustmentStarted = false;

                term.write(`\x1b[91m${data}\x1b[0m`); // Light red text for errors, no background
            });

            term.attachCustomKeyEventHandler((arg) => {
                if (arg.ctrlKey && arg.code === "KeyC" && arg.type === "keydown") {
                    const selection = term.getSelection();
                    if (selection) {
                        clipboard.writeText(selection);
                        return false;
                    }
                }
                return true;
            });

            document.getElementById("terminal").addEventListener('contextmenu', () => {
                if (term.hasSelection()) {
                    document.execCommand('copy')
                    term.select(0, 0, 0)
                } else {
                    ipcRenderer.send('terminal-data', clipboard.readText())
                }
            })
        </script>
    </div>
    <script>

        async function loadSettings() {
            const settings = await ipcRenderer.invoke('settings.getSettings');
            if (settings) {
                // autoUpdateGSMAppCheckbox.checked = settings.autoUpdateGSMApp || false;
                // autoUpdateElectronCheckbox.checked = settings.autoUpdateElectron || false;
                // pythonPathInput.value = settings.pythonPath || '';
                // agentScriptsPathInput.value = settings.agentScriptsPath || '';
                // startConsoleMinimizedCheckbox.checked = settings.startConsoleMinimized || false;
                // customPythonPackageInput.value = settings.customPythonPackage || 'GameSentenceMiner';
                // let showYuzuTab = settings.showYuzuTab || false;
                // if (showYuzuTab) {
                //     document.getElementById('yuzu-button').style.display = 'inline-block';
                // } else {
                //     document.getElementById('yuzu-button').style.display = 'none';
                // }
                
                // Handle visible tabs
                const visibleTabs = settings.visibleTabs || ['launcher', 'stats', 'python', 'console'];
                const controllableTabs = ['launcher', 'stats', 'python', 'console'];
                
                controllableTabs.forEach(tabId => {
                    const tabButton = document.querySelector(`[data-tab="${tabId}"]`);
                    if (tabButton) {
                        if (visibleTabs.includes(tabId)) {
                            tabButton.style.display = '';
                            tabButton.style.pointerEvents = 'auto';
                        } else {
                            tabButton.style.display = 'none';
                            tabButton.style.pointerEvents = 'none';
                        }
                    }
                });
            }
        }

        // const { ipcRenderer } = require('electron');

        // function loadNewPage(url) {
        //     ipcRenderer.send('load-page', url); // Send the URL to the main process
        // }

        // Example usage: load a new page when a button is clicked
        // const tabButtons = document.querySelectorAll('.tab-button');
        // tabButtons.forEach(button => {
        //     button.addEventListener('click', () => {
        //         const selectedTab = button.dataset.tab;
        //         const otherContents = document.querySelectorAll('.tab-content:not(#' + selectedTab + ')');
        //
        //         document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        //         button.classList.add('active');
        //
        //         // Hide all other contents and show the selected one
        //         otherContents.forEach(content => content.classList.remove('active'));
        //
        //         // Load the selected page
        //         loadNewPage(selectedTab + '.html');
        //     });
        // });
        //
        // loadNewPage("console.html")
        let fitInterval;
        let statsRetryTimer;
        let statsLoadInProgress = false;

        function showStatsLoading(message) {
            const loading = document.getElementById('stats-loading');
            if (!loading) return;
            const text = loading.querySelector('div:last-child');
            if (text && message) {
                text.textContent = message;
            }
            loading.style.display = 'flex';
        }

        function hideStatsLoading() {
            const loading = document.getElementById('stats-loading');
            if (loading) {
                loading.style.display = 'none';
            }
        }

        async function waitForStatsEndpoint(url) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 2000);
            try {
                const response = await fetch(url, { signal: controller.signal });
                return response && response.ok;
            } catch (error) {
                return false;
            } finally {
                clearTimeout(timeoutId);
            }
        }

        async function loadStatsTab() {
            if (statsLoadInProgress) return;
            statsLoadInProgress = true;

            const settings = await ipcRenderer.invoke('settings.getSettings');
            const statsEndpoint = settings?.statsEndpoint || 'overview';
            const statsUrl = `http://localhost:7275/${statsEndpoint}`;
            const statsIframe = document.querySelector('#stats iframe');

            const isAvailable = await waitForStatsEndpoint(statsUrl);
            if (isAvailable) {
                hideStatsLoading();
                statsIframe.src = statsUrl;
                statsLoadInProgress = false;
                return;
            }

            showStatsLoading('Waiting for GSM stats to load...');
            statsLoadInProgress = false;

            if (!statsRetryTimer) {
                statsRetryTimer = setInterval(async () => {
                    const ready = await waitForStatsEndpoint(statsUrl);
                    if (ready) {
                        clearInterval(statsRetryTimer);
                        statsRetryTimer = null;
                        hideStatsLoading();
                        statsIframe.src = statsUrl;
                    }
                }, 2000);
            }
        }

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', async () => {
                // Remove active class from all buttons and content
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                fitAddon.fit();

                // Add active class to clicked button and corresponding content
                const tabId = button.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
                button.classList.add('active');


                if (tabId === 'console') {
                    fitInterval = setInterval(async () => {
                        fitAddon.fit();
                    }, 1);

                    setTimeout(() => {
                        clearInterval(fitInterval);
                    }, 100);
                } else {
                    clearInterval(fitInterval);
                }

                if (tabId === 'stats') {
                    // Load the configured stats endpoint into the iframe when ready
                    await loadStatsTab();
                }

                if (tabId === 'launcher') {
                    const launcherIframe = document.querySelector('#launcher iframe');
                    launcherIframe.src = launcherIframe.src; // Force reload
                }

                // Notify main process of tab change
                ipcRenderer.send('tab-changed', tabId);
            });
        });

        // Listen for installation messages from main process
        ipcRenderer.on('installing', (event, data) => {
            // showPythonStatus(data.message, 'info');
            // Optionally switch to console tab to show progress
            switchToConsoleTab();
        });

        // Initialize Python tab on DOM load
        initializePythonTab();

        loadSettings();
        setInterval(loadSettings, 500);

        // Initialize Python tab functionality
        function initializePythonTab() {
            // Load Python info on page load
            // loadPythonInfo();

            // CUDA Installation
            document.getElementById('install-cuda-btn').addEventListener('click', async () => {
                const confirmed = await ipcRenderer.invoke('show-message-box', {
                    type: 'warning',
                    title: 'Install CUDA GPU Support',
                    message: 'Install CUDA GPU Support?',
                    detail: 'This will install CUDA GPU support for faster processing for Whisper and MeikiOCR:\n\n' +
                            '‚Ä¢ Requires approximately 2GB of additional storage\n' +
                            '‚Ä¢ May not be compatible with all systems\n' +
                            '‚Ä¢ Install at your own risk\n\n' +
                            'If you experience issues after installation, GSM *should* recover gracefully, but you may have to delete the "python_venv" folder manually.',
                    buttons: ['Cancel', 'Install'],
                    defaultId: 0,
                    cancelId: 0
                });

                if (confirmed.response !== 1) {
                    showPythonStatus('CUDA installation cancelled.', 'info');
                    return;
                }

                showPythonStatus('Installing CUDA GPU support... This may take several minutes.');
                switchToConsoleTab(); // Switch to console to see progress

                try {
                    const result = await ipcRenderer.invoke('python.installCudaPackage');
                    if (result.success) {
                        showPythonStatus(`‚úÅE${result.message}`, 'success');
                    } else {
                        showPythonStatus(`‚ùÅE${result.message}`, 'error');
                    }
                } catch (error) {
                    showPythonStatus(`‚ùÅEError installing CUDA: ${error.message}`, 'error');
                }
            });

            // Uninstall CUDA
            document.getElementById('uninstall-cuda-btn').addEventListener('click', async () => {
                const confirmed = await ipcRenderer.invoke('show-message-box', {
                    type: 'warning',
                    title: 'Uninstall CUDA GPU Support',
                    message: 'Uninstall CUDA GPU Support?',
                    detail: 'This will uninstall onnxruntime-gpu. \n\n' +
                            'Use this if you are experiencing crashes or issues with the GPU version.',
                    buttons: ['Cancel', 'Uninstall'],
                    defaultId: 0,
                    cancelId: 0
                });

                if (confirmed.response !== 1) {
                    showPythonStatus('CUDA uninstallation cancelled.', 'info');
                    return;
                }

                showPythonStatus('Uninstalling CUDA GPU support...');
                switchToConsoleTab();

                try {
                    const result = await ipcRenderer.invoke('python.uninstallCudaPackage');
                    if (result.success) {
                        showPythonStatus(`‚úÅE${result.message}`, 'success');
                    } else {
                        showPythonStatus(`‚ùÅE${result.message}`, 'error');
                    }
                } catch (error) {
                    showPythonStatus(`‚ùÅEError uninstalling CUDA: ${error.message}`, 'error');
                }
            });

            // Reset Dependencies
            document.getElementById('reset-deps-btn').addEventListener('click', async () => {
                const confirmed = await ipcRenderer.invoke('show-message-box', {
                    type: 'warning',
                    title: 'Reset Python Dependencies',
                    message: 'Reset Python Dependencies?',
                    detail: 'This will run "uv sync --locked" to reset your Python environment to the locked dependency set defined in the lockfile.\n\n' + 
                            'This is useful if you have manually installed packages that are causing conflicts.',
                    buttons: ['Cancel', 'Reset'],
                    defaultId: 0,
                    cancelId: 0
                });

                if (confirmed.response !== 1) {
                    showPythonStatus('Dependency reset cancelled.', 'info');
                    return;
                }

                showPythonStatus('Resetting Python dependencies (strict uv lock sync)...');
                switchToConsoleTab();

                try {
                    const result = await ipcRenderer.invoke('python.resetDependencies');
                    if (result.success) {
                        showPythonStatus(`‚úÅE${result.message}`, 'success');
                    } else {
                        showPythonStatus(`‚ùÅE${result.message}`, 'error');
                    }
                } catch (error) {
                    showPythonStatus(`‚ùÅEError resetting dependencies: ${error.message}`, 'error');
                }
            });

            // CUDA Guide
            // document.getElementById('cuda-guide-btn').addEventListener('click', async () => {
            //     await ipcRenderer.invoke('python.openCudaGuide');
            // });

            // Repair GSM
            // document.getElementById('repair-gsm-btn').addEventListener('click', async () => {
            //     if (confirm('THIS IS ONLY TO BE USED IF SOMETHING IS COMPLETELY BROKEN WITH GSM DUE TO A CUSTOM/BAD PYTHON PACKAGE INSTALLATION. THIS SHOULD NOT BE EXPECTED TO FIX MINOR ISSUES, AND HAS A HIGHER CHANCE OF DOING MORE PAIN THAN GOOD.\n\nAre you sure you want to proceed with repairing GSM?')) {
            //         showPythonStatus('üîß Repairing GSM... This may take several minutes.');
            //         switchToConsoleTab(); // Switch to console to see progress

            //         try {
            //             const result = await ipcRenderer.invoke('python.repairGSM');
            //             if (result.success) {
            //                 showPythonStatus(`‚úÅE${result.message}`, 'success');
            //                 loadPythonInfo(); // Refresh info after repair
            //             } else {
            //                 showPythonStatus(`‚ùÅE${result.message}`, 'error');
            //             }
            //         } catch (error) {
            //             showPythonStatus(`‚ùÅEError repairing GSM: ${error.message}`, 'error');
            //         }
            //     }
            // });

            // Clean cache
            // document.getElementById('clean-cache-btn').addEventListener('click', async () => {
            //     showPythonStatus('üßπ Cleaning Python cache...');

            //     try {
            //         const result = await ipcRenderer.invoke('python.cleanCache');
            //         if (result.success) {
            //             showPythonStatus(`‚úÅE${result.message}`, 'success');
            //         } else {
            //             showPythonStatus(`‚ùÅE${result.message}`, 'error');
            //         }
            //     } catch (error) {
            //         showPythonStatus(`‚ùÅEError cleaning cache: ${error.message}`, 'error');
            //     }
            // });

            // Install custom package
            document.getElementById('install-custom-package-btn').addEventListener('click', async () => {
                const packageName = document.getElementById('custom-package-input').value.trim();
                if (!packageName) {
                    alert('Please enter a package name');
                    return;
                }

                showPythonStatus(`Installing package: ${packageName}...`);
                switchToConsoleTab(); // Switch to console to see progress

                try {
                    const result = await ipcRenderer.invoke('python.installCustomPackage', packageName);
                    if (result.success) {
                        showPythonStatus(`‚úÅE${result.message}`, 'success');
                        document.getElementById('custom-package-input').value = ''; // Clear input
                    } else {
                        showPythonStatus(`‚ùÅE${result.message}`, 'error');
                    }
                } catch (error) {
                    showPythonStatus(`‚ùÅEError installing package: ${error.message}`, 'error');
                }
            });

            // Refresh Python info
            document.getElementById('refresh-python-info-btn').addEventListener('click', loadPythonInfo);

            // Allow Enter key in package input
            document.getElementById('custom-package-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('install-custom-package-btn').click();
                }
            });
        }

        async function loadPythonInfo() {
            try {
                const info = await ipcRenderer.invoke('python.getPythonInfo');
                if (info.success) {
                    document.getElementById('python-version').textContent = `Python Version: ${info.pythonVersion}`;
                    document.getElementById('python-path').textContent = `Python Path: ${info.pythonPath}`;
                    document.getElementById('pip-version').textContent = `Pip Version: ${info.pipVersion}`;
                } else {
                    document.getElementById('python-version').textContent = 'Python Version: Error loading';
                    document.getElementById('python-path').textContent = 'Python Path: Error loading';
                    document.getElementById('pip-version').textContent = 'Pip Version: Error loading';
                }
            } catch (error) {
                console.error('Failed to load Python info:', error);
            }
        }

        function showPythonStatus(message, type = 'info') {
            const statusCard = document.getElementById('python-status-card');
            const statusText = document.getElementById('python-status-text');

            statusText.textContent = message;
            statusCard.style.display = 'block';

            // Auto-hide success/error messages after 10 seconds
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusCard.style.display = 'none';
                }, 10000);
            }
        }

        // Setup collapsible sections for Python tab
        function setupPythonCollapsibleSections() {
            const pythonHeaders = document.querySelectorAll('#python .collapsible-header');
            pythonHeaders.forEach(header => {
                header.addEventListener('click', function () {
                    const content = this.nextElementSibling;
                    const arrow = this.querySelector('.arrow-icon');

                    if (content.style.display === 'none' || content.style.display === '') {
                        content.style.display = 'block';
                        arrow.textContent = '‚ñ≤';
                    } else {
                        content.style.display = 'none';
                        arrow.textContent = '‚ñº';
                    }
                });
            });
        }

        // Initialize collapsible sections
        setupPythonCollapsibleSections();
        
        // ====================================================================
        // Shared State: Detect and store OS information for all pages
        // ====================================================================
        
        async function detectAndStoreOSInfo() {
            // Detect the OS
            const platform = window.gsmEnv?.platform || 'win32';
            const isWindows = platform === 'win32';
            const isMac = platform === 'darwin';
            const isLinux = platform === 'linux';
            // const isWindows = false;
            // const isMac = true;
            // const isLinux = false;
            
            const osInfo = {
                platform,
                isWindows,
                isMac,
                isLinux,
                detectedAt: Date.now()
            };
            
            // Store in shared state so all pages can access it
            await sharedState.setState('systemInfo', osInfo);
            console.log('üñ•ÔøΩEÔøΩESystem Information detected and stored:', osInfo);
        }
        
        // Detect OS on page load
        detectAndStoreOSInfo();
    </script>
</body>

</html>



