name: Build Electron App (Artifacts)

on:
  push:
    # branches:
    #   - develop # Or your default branch
    #   - qt6-clean
  pull_request:    # <--- ADD THIS
    branches:
      - develop   # Or any other branches you want to allow PRs for
  workflow_dispatch: # Allow manual trigger

# Grant read permissions for checking releases and write for uploading assets
permissions:
  contents: write   # Needed for checkout and uploading to releases
  packages: none   # Not needed
  actions: read    # Not needed unless using specific actions requiring it
  pull-requests: none # Not needed
  issues: none        # Not needed

jobs:
  setup-release:
    runs-on: ubuntu-latest
    outputs:
      RELEASE_TAG: ${{ steps.get_release.outputs.RELEASE_TAG }}
      RELEASE_BODY: ${{ steps.get_release.outputs.RELEASE_BODY }}
      PACKAGE_VERSION: ${{ steps.get_version.outputs.PACKAGE_VERSION }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install GitHub CLI
        uses: crazy-max/gh-action@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Get latest pre-release and clear assets
        id: get_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          release_info=$(gh release list --limit 1 --json tagName,id,body,isPrerelease)
          if [[ "$(echo "$release_info" | jq -r .isPrerelease)" == "true" ]]; then
            tag_name=$(echo "$release_info" | jq -r .tagName)
            release_id=$(echo "$release_info" | jq -r .id)
            release_body=$(echo "$release_info" | jq -r .body)
            echo "Latest release is a pre-release. Tag: $tag_name"
            echo "RELEASE_TAG=$tag_name" >> $GITHUB_OUTPUT
            {
              echo "RELEASE_BODY<<EOF"
              echo "$release_body"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
            assets=$(gh api repos/${{ github.repository }}/releases/$release_id/assets)
            asset_ids=$(echo "$assets" | jq -r '.[].id')
            if [[ -n "$asset_ids" ]]; then
              echo "Deleting assets from release $tag_name"
              for asset_id in $asset_ids; do
                gh api -X DELETE repos/${{ github.repository }}/releases/assets/$asset_id
              done
            else
              echo "No assets to delete."
            fi
            gh release edit "$tag_name" --notes "Build in progress... ðŸš€"
          else
            echo "The latest release is not a pre-release. Skipping asset deletion and upload."
            echo "RELEASE_TAG=none" >> $GITHUB_OUTPUT
          fi
      - name: Get version from package.json
        id: get_version
        run: echo "PACKAGE_VERSION=$(jq -r .version package.json)" >> $GITHUB_OUTPUT

  electron-build-windows:
    needs: setup-release
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '21'


      - name: Convert Handlebar files to LF line endings
        run: |
            Get-ChildItem -Path ./GSM_Overlay/yomitan/data/templates -Recurse -Include *.handlebars | ForEach-Object {
            $content = (Get-Content $_.FullName -Raw) -replace "`r`n", "`n"
            Set-Content $_.FullName $content -NoNewline
            }

      - name: Build Overlay
        id: build_overlay
        working-directory: ./GSM_Overlay
        run: |
          npm install
          npm run package

      - name: Install dependencies
        run: |
          npm install

      - name: Build Electron app
        if: steps.build_overlay.outcome == 'success'
        run: |
          npm run app:dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows unpacked build as artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-unpacked-v${{ needs.setup-release.outputs.PACKAGE_VERSION }}
          path: dist/win-unpacked/

      - name: Zip and upload Windows build
        if: needs.setup-release.outputs.RELEASE_TAG != 'none'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $zipfile = "dist/windows-unpacked-v${{ needs.setup-release.outputs.PACKAGE_VERSION }}.zip"
          Compress-Archive -Path dist/win-unpacked -DestinationPath $zipfile
          gh release upload ${{ needs.setup-release.outputs.RELEASE_TAG }} $zipfile --clobber
  electron-build-linux:
    needs: setup-release
    runs-on: ubuntu-latest
    # needs: electron-build-windows
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '21'

      - name: Build Overlay
        id: build_overlay_linux
        working-directory: ./GSM_Overlay
        run: |
          npm install
          npm run package

      - name: Install dependencies
        run: |
          npm install
          npm install --save-dev electron electron-builder

      - name: Build Electron app for Linux
        if: steps.build_overlay_linux.outcome == 'success'
        run: |
          npm run app:dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux unpacked build as artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-unpacked-v${{ needs.setup-release.outputs.PACKAGE_VERSION }}
          path: dist/linux-unpacked/

      - name: Zip and upload Linux build
        if: needs.setup-release.outputs.RELEASE_TAG != 'none'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          zip -r dist/linux-unpacked-v${{ needs.setup-release.outputs.PACKAGE_VERSION }}.zip dist/linux-unpacked
          gh release upload ${{ needs.setup-release.outputs.RELEASE_TAG }} dist/linux-unpacked-v${{ needs.setup-release.outputs.PACKAGE_VERSION }}.zip --clobber
  electron-build-mac:
    needs: setup-release
    runs-on: macos-latest
    # needs: electron-build-windows
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '21'

      - name: Build Overlay
        id: build_overlay_linux
        working-directory: ./GSM_Overlay
        run: |
          npm install
          npm run package

      - name: Install dependencies
        run: |
          npm install
          npm install --save-dev electron electron-builder

      - name: Build Electron app for macOS
        run: |
          npm run app:dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload macOS unpacked build as artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-unpacked-v${{ needs.setup-release.outputs.PACKAGE_VERSION }}
          path: dist/mac/

      - name: Zip and upload macOS build
        if: needs.setup-release.outputs.RELEASE_TAG != 'none'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          zip -r dist/macos-unpacked-v${{ needs.setup-release.outputs.PACKAGE_VERSION }}.zip dist/mac
          gh release upload ${{ needs.setup-release.outputs.RELEASE_TAG }} dist/macos-unpacked-v${{ needs.setup-release.outputs.PACKAGE_VERSION }}.zip --clobber

  finalize-release:
    runs-on: ubuntu-latest
    needs: [electron-build-windows, electron-build-linux, electron-build-mac]
    if: always() && needs.setup-release.outputs.RELEASE_TAG != 'none'
    steps:
      - name: Install GitHub CLI
        uses: crazy-max/gh-action@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Restore release description
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release edit ${{ needs.setup-release.outputs.RELEASE_TAG }} --notes "${{ needs.setup-release.outputs.RELEASE_BODY }}"