name: Build Electron App (Artifacts)

on:
  push:
    branches:
      - develop # Or your default branch
      - qt6-clean
  pull_request:    # <--- ADD THIS
    branches:
      - develop   # Or any other branches you want to allow PRs for
  workflow_dispatch: # Allow manual trigger

# Grant read permissions for checking releases and write for uploading assets
permissions:
  contents: write   # Needed for checkout and uploading to releases
  packages: none   # Not needed
  actions: read    # Not needed unless using specific actions requiring it
  pull-requests: none # Not needed
  issues: none        # Not needed

jobs:
  electron-build-windows:
    runs-on: windows-latest
    outputs:
      PACKAGE_VERSION: ${{ steps.get_version.outputs.PACKAGE_VERSION }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '21'

      - name: Get version from package.json
        id: get_version
        run: |
          echo "Fetching version from package.json..."
          $PACKAGE_VERSION = (Get-Content -Raw -Path ./package.json | ConvertFrom-Json).version
          if (-not $PACKAGE_VERSION) {
            echo "Error: Could not extract version from package.json"
            exit 1
          }
          echo "Package Version: $PACKAGE_VERSION"
          echo "PACKAGE_VERSION=$PACKAGE_VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Convert Handlebar files to LF line endings
        run: |
            Get-ChildItem -Path ./GSM_Overlay/yomitan/data/templates -Recurse -Include *.handlebars | ForEach-Object {
            $content = (Get-Content $_.FullName -Raw) -replace "`r`n", "`n"
            Set-Content $_.FullName $content -NoNewline
            }

      - name: Build Overlay
        id: build_overlay
        working-directory: ./GSM_Overlay
        run: |
          npm install
          npm run package

      - name: Install dependencies
        run: |
          npm install

      - name: Build Electron app
        if: steps.build_overlay.outcome == 'success'
        run: |
          npm run app:dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-v${{ steps.get_version.outputs.PACKAGE_VERSION }}
          path: |
            dist/*Setup*.exe
            dist/latest.yml
            dist/*.blockmap
  electron-build-linux:
    runs-on: ubuntu-latest
    # needs: electron-build-windows
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '21'

      - name: Build Overlay
        id: build_overlay_linux
        working-directory: ./GSM_Overlay
        run: |
          npm install
          npm run package

      - name: Install dependencies
        run: |
          npm install
          npm install --save-dev electron electron-builder

      - name: Build Electron app for Linux
        if: steps.build_overlay_linux.outcome == 'success'
        run: |
          npm run app:dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build-v${{ needs.electron-build-windows.outputs.PACKAGE_VERSION }}
          path: dist/*.AppImage
  electron-build-mac:
    runs-on: macos-latest
    # needs: electron-build-windows
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '21'

      - name: Install dependencies
        run: |
          npm install
          npm install --save-dev electron electron-builder

      - name: Build Electron app for macOS
        run: |
          npm run app:dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build-v${{ needs.electron-build-windows.outputs.PACKAGE_VERSION }}
          path: dist/*.dmg

  upload-to-prerelease:
    runs-on: ubuntu-latest
    needs: [electron-build-windows, electron-build-linux, electron-build-mac]
    if: github.ref == 'refs/heads/develop'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get latest pre-release
        id: get_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_ID=$(gh api /repos/${{ github.repository }}/releases | jq -r '[.[] | select(.prerelease == true)] | .[0].id')
          if [ -z "$RELEASE_ID" ] || [ "$RELEASE_ID" = "null" ]; then
            echo "No pre-release found"
            exit 1
          fi
          echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_OUTPUT
          echo "Found pre-release ID: $RELEASE_ID"

      - name: Delete existing assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ASSETS=$(gh api /repos/${{ github.repository }}/releases/${{ steps.get_release.outputs.RELEASE_ID }}/assets | jq -r '.[].id')
          for ASSET_ID in $ASSETS; do
            echo "Deleting asset $ASSET_ID"
            gh api --method DELETE /repos/${{ github.repository }}/releases/assets/$ASSET_ID
          done

      - name: Upload new assets to pre-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          find artifacts -type f \( -name "*.exe" -o -name "*.AppImage" -o -name "*.dmg" -o -name "*.yml" -o -name "*.blockmap" \) -exec gh release upload ${{ steps.get_release.outputs.RELEASE_ID }} {} --clobber \;
